<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shapemaker Web</title>
  </head>
  <body>
    <script type="module">
      import init, { render_image, Color, color_name } from "./shapemaker.js"
      async function run() {
        await init()
        window.renderImage = (vel, col) => {
          console.log([...arguments])
          document.querySelector(`.frame[data-color=${color_name(col)}]`)?.remove()
          render_image(vel, col)
        }
      }
      run()

      window.pedal_held = false

      window.addEventListener("keypress", (e) => {
        if (e.key === " ") {
          window.renderImage(1, Color.White)
        }
      })

      console.log("requesting midi access")
      navigator.requestMIDIAccess().then((midiAccess) => {
        Array.from(midiAccess.inputs).forEach((input) => {
          input[1].onmidimessage = (msg) => {
            const [cmd, ...args] = [...msg.data]
            if (cmd === 248) return
            console.log(cmd, args)
            if (cmd === 176 && args[0] === 64) {
              const [_, intensity] = args
              if (intensity === 0) {
                document
                  .querySelectorAll(".frame")
                  ?.forEach((frame) => frame.remove())
              }
              return
            }
            if (cmd !== 144) return
            const [pitch, velocity] = args
            if (velocity === 0) return
            const colors = [
              Color.Blue,
              Color.Purple,
              Color.Pink,
              Color.Red,
              Color.Orange,
              Color.Yellow,
              Color.Green,
              Color.Cyan,
              Color.White,
            ]
            // get color uniformly in this range from 28 (lowest pitch) to 103 (highest pitch)

            const color =
              colors[Math.floor(((pitch - 28) / (103 - 28)) * colors.length)]
            console.log(pitch, color)
            window.renderImage(velocity / 128, color ?? "white")
          }
        })
      })
    </script>
    <style>
      body {
        background: #000;
      }

      .frame {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    </style>
  </body>
  <!-- <button onclick="render_image('white')">Render Image</button> -->
</html>
